# name: Build ZMK firmware
# on: [push, pull_request, workflow_dispatch]

# jobs:
#   build:
#     uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main

name: Build ZMK firmware
on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. è‡ªèº«ã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰è¨­å®šãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      #    ZMK_CONFIG ã«åˆ©ç”¨ã™ã‚‹ãŸã‚ 'config' ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®
      - name: Checkout Config
        uses: actions/checkout@v4
        with:
          path: config

      # 2. ğŸ’¡ å¿…è¦ãªå¤–éƒ¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (zmk-input-gestures) ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      #    extra_modules ã§ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã€ãƒ«ãƒ¼ãƒˆã«é…ç½®
      - name: Checkout ZMK Input Gestures Module
        uses: actions/checkout@v4
        with:
          repository: halfdane/zmk-input-gestures
          path: zmk-input-gestures

      # 3. ZMKå…¬å¼ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã€ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up ZMK and Toolchain
        uses: zmkfirmware/setup-zmk@v2

      # 4. ZMKãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åˆæœŸåŒ–ãƒ»æ›´æ–°
      - name: West Init/Update
        run: |
          west init -l zmk/app
          west update

      # 5. ZMK ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
      - name: West Build Firmware
        run: |
          # å·¦å³ä¸¡æ–¹ã®ã‚·ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã‚ã€ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§æŒ‡å®š
          # ZMK_EXTRA_MODULES ã«ã¯ã€ config ã¨ zmk-input-gestures ã®ä¸¡æ–¹ã®ãƒ‘ã‚¹ã‚’ ; åŒºåˆ‡ã‚Šã§æ¸¡ã™
          west build -s zmk/app -b akdk_bt1 -- \
            -DSHIELD="split_ortho4x6_right split_ortho4x6_left" \
            -DZMK_CONFIG=config \
            -DZMK_EXTRA_MODULES="zmk-input-gestures" \
            -DCONFIG_ZMK_STUDIO=y

      # 6. ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã‚’æˆæœç‰©ã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Archive artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-split-ortho4x6
          # UF2ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã¦åœ§ç¸®ã™ã‚‹
          path: |
            build/zephyr/*.uf2
            build_split_ortho4x6_left/zephyr/*.uf2
            build_split_ortho4x6_right/zephyr/*.uf2
          retention-days: 7
